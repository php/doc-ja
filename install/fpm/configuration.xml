<?xml version="1.0" encoding="utf-8"?>
<!-- $Revision$ -->
<!-- EN-Revision: 3d1de5938ef6812f13dbe7d067190e898f5351a9 Maintainer: takagi Status: ready -->
  <sect1 xml:id="install.fpm.configuration" xmlns="http://docbook.org/ns/docbook" xmlns:xlink="http://www.w3.org/1999/xlink">
   <title>設定</title>
   <para>
    FPM では、&php.ini; 形式の構文の設定ファイル <filename>php-fpm.conf</filename> を使います。
   </para>
   <sect2> 
    <title><filename>php-fpm.conf</filename> のグローバル設定項目</title>
    <variablelist>
     <varlistentry xml:id="pid">
      <term>
       <parameter>pid</parameter>
       <type>string</type>
      </term>
      <listitem>
       <para>
        PID ファイルへのパス。デフォルト値: なし
       </para> 
      </listitem>
     </varlistentry>
     <varlistentry xml:id="error-log">
      <term>
       <parameter>error_log</parameter>
       <type>string</type>
      </term>
      <listitem>
       <para>
        エラーログファイルへのパス。デフォルト値:
        <literal>#INSTALL_PREFIX#/log/php-fpm.log</literal>
       </para> 
      </listitem>
     </varlistentry>
     <varlistentry xml:id="log-level">
      <term>
       <parameter>log_level</parameter>
       <type>string</type>
      </term>
      <listitem>
       <para>
        エラーログのレベル。使用可能な値: alert, error, warning, notice,
        debug、デフォルト値: notice
       </para> 
      </listitem>
     </varlistentry>
     <varlistentry xml:id="emergency-restart-threshold">
      <term>
       <parameter>emergency_restart_threshold</parameter>
       <type>int</type>
      </term>
      <listitem>
       <para>
        <literal>emergency_restart_interval</literal> で設定された間隔で
        この数以上の子プロセスが SIGSEGV あるいは SIGBUS で終了した場合に
        FPM は再起動します。0 は 'オフ' を意味します。デフォルト値: 0 (オフ)
       </para> 
      </listitem>
     </varlistentry>
     <varlistentry xml:id="emergency-restart-interval">
      <term>
       <parameter>emergency_restart_interval</parameter>
       <type>mixed</type>
      </term>
      <listitem>
       <para>
        emergency_restart_interval が緩やかな再起動をいつ実行するかを決めるときに使う間隔。
        これは、アクセラレータの共有メモリが壊れてしまったときの回避策として有用です。
        使用可能な単位: s(秒), m(分), h(時間) あるいは d(日)、
        デフォルトの単位: 秒、デフォルト値: 0 (オフ)
       </para> 
      </listitem>
     </varlistentry>
     <varlistentry xml:id="process-control-timeout">
      <term>
       <parameter>process_control_timeout</parameter>
       <type>mixed</type>
      </term>
      <listitem>
       <para>
        子プロセスが、マスタからのシグナルの反応を待つ最大時間。
        使用可能な単位: s(秒), m(分), h(時間) あるいは d(日)、
        デフォルトの単位: 秒、デフォルト値: 0
       </para> 
      </listitem>
     </varlistentry>
     <varlistentry xml:id="daemonize">
      <term>
       <parameter>daemonize</parameter>
       <type>boolean</type>
      </term>
      <listitem>
       <para>
        FPM をバックグラウンドに送る。'no' にすると
        デバッグ用に FPM をフォアグラウンドに置き続けます。
        デフォルト値: yes
       </para> 
      </listitem>
     </varlistentry>
    </variablelist>
   </sect2>

   <sect2> 
    <title>プール一覧の項目</title>
    <para>
     FPM を使うと、複数のプロセスプールをそれぞれ別の設定で実行することができます。
     プール単位での設定を行う項目を以下に示します。
    </para>
    <variablelist>
     <varlistentry xml:id="listen">
      <term>
       <parameter>listen</parameter>
       <type>string</type>
      </term>
      <listitem>
       <para>
        FastCGI リクエストを受け入れるアドレス。
        'ip.add.re.ss:port', 'port', '/path/to/unix/socket' 形式の構文が使えます。
        このオプションは、各プール単位で必須となります。
       </para> 
      </listitem>
     </varlistentry>
     <varlistentry xml:id="listen-backlog">
      <term>
       <parameter>listen.backlog</parameter>
       <type>int</type>
      </term>
      <listitem>
       <para>
        listen(2) のバックログを設定します。'-1' は無制限を意味します。
        デフォルト値: -1
       </para> 
      </listitem>
     </varlistentry>
     <varlistentry xml:id="listen-allowed-clients">
      <term>
       <parameter>listen.allowed_clients</parameter>
       <type>string</type>
      </term>
      <listitem>
       <para>
        接続を許可されている FastCGI クライアントの ipv4 アドレス一覧。オリジナル版 PHP FastCGI (5.2.2+)
        における環境変数 FCGI_WEB_SERVER_ADDRS と同じです。
        tcp でリスンするソケットに対してのみ意味をなします。
        書くアドレスはカンマ区切りで指定します。この値を空にしておくと、任意の ip アドレスからの接続を許可します。
        デフォルト値: 任意の ip アドレスを許可
       </para> 
      </listitem>
     </varlistentry>
     <varlistentry xml:id="listen-owner">
      <term>
       <parameter>listen.owner</parameter>
       <type>string</type>
      </term>
      <listitem>
       <para>
        unix ソケットを使う場合に、そのパーミッションを設定します。Linux では、
        読み書きアクセス権限を設定しないとウェブサーバーからの接続を受け付けることができません。
        多くの BSD 由来のシステムでは、パーミッションにかかわらず接続を受け付けることができます。
        デフォルト値: ユーザーとグループは実行しているユーザーと同じ、モードは 0666
       </para> 
      </listitem>
     </varlistentry>
     <varlistentry xml:id="listen-group">
      <term>
       <parameter>listen.group</parameter>
       <type>string</type>
      </term>
      <listitem>
       <para>
        <literal>listen.owner</literal> を参照ください。
       </para> 
      </listitem>
     </varlistentry>
     <varlistentry xml:id="listen-mode">
      <term>
       <parameter>listen.mode</parameter>
       <type>string</type>
      </term>
      <listitem>
       <para>
        <literal>listen.owner</literal> を参照ください。
       </para> 
      </listitem>
     </varlistentry>
     <varlistentry xml:id="user">
      <term>
       <parameter>user</parameter>
       <type>string</type>
      </term>
      <listitem>
       <para>
        FPM プロセスの unix ユーザー。このオプションは必須です。
       </para> 
      </listitem>
     </varlistentry>
     <varlistentry xml:id="group">
      <term>
       <parameter>group</parameter>
       <type>string</type>
      </term>
      <listitem>
       <para>
        FPM プロセスの unix グループ。未設定の場合は、デフォルトのユーザーのグループを使います。
       </para> 
      </listitem>
     </varlistentry>
     <varlistentry xml:id="pm">
      <term>
       <parameter>pm</parameter>
       <type>string</type>
      </term>
      <listitem>
       <para>
        プロセスマネージャが子プロセスの数を制御する方法を選択します。
        使用可能な値: <literal>static</literal>, <literal>ondemand</literal>, <literal>dynamic</literal>
        このオプションは必須です。
       </para>
       <para>
        <literal>static</literal> - 子プロセスの数は固定 (<literal>pm.max_children</literal>) です。
       </para>
       <para>
        <literal>ondemand</literal> - プロセスを必要に応じて立ち上げます。
        dynamic とは対照的に、リクエストされると
        <literal>pm.start_servers</literal> で指定しただけサービスを開始します。
       </para>
       <para>
        <literal>dynamic</literal> - 子プロセスの数は、
        <literal>pm.max_children</literal>、<literal>pm.start_servers</literal>、
        <literal>pm.min_spare_servers</literal>、<literal>pm.max_spare_servers</literal>
        の内容に基づいて動的に設定されます。
       </para>
      </listitem>
     </varlistentry>
     <varlistentry xml:id="pm.max-chidlren">
      <term>
       <parameter>pm.max_children</parameter>
       <type>int</type>
      </term>
      <listitem>
       <para>
        <literal>pm</literal> が <literal>static</literal> の場合は作成される子プロセスの数、
        <literal>pm</literal> が <literal>dynamic</literal> の場合は作成される子プロセスの最大数。
        このオプションは必須です。
       </para>
       <para>
        このオプションは、同時に処理できるリクエストの最大数を設定します。 
        mpm_prefork での ApacheMaxClients ディレクティブや、
        オリジナル版の PHP FastCGI における環境変数 <varname>PHP_FCGI_CHILDREN</varname>
        と同じです。
       </para>
      </listitem>
     </varlistentry>
     <varlistentry xml:id="pm.start-servers">
      <term>
       <parameter>pm.start_servers</parameter>
       <type>in</type>
      </term>
      <listitem>
       <para>
        起動時に作成される子プロセスの数。<literal>pm</literal> が <literal>dynamic</literal>
        の場合にのみ使います。デフォルト値: min_spare_servers + (max_spare_servers -
        min_spare_servers) / 2
       </para> 
      </listitem>
     </varlistentry>
     <varlistentry xml:id="pm.min-spare-servers">
      <term>
       <parameter>pm.min_spare_servers</parameter>
       <type>int</type>
      </term>
      <listitem>
       <para>
        アイドル状態のサーバープロセス数の最小値。
        <literal>pm</literal> が <literal>dynamic</literal> の場合にのみ使います。
        また、この場合には必須となります。
       </para> 
      </listitem>
     </varlistentry>
     <varlistentry xml:id="pm.max-spare-servers">
      <term>
       <parameter>pm.max_spare_servers</parameter>
       <type>int</type>
      </term>
      <listitem>
       <para>
        アイドル状態のサーバープロセス数の最大値。
        <literal>pm</literal> が <literal>dynamic</literal> の場合にのみ使います。
        また、この場合には必須となります。
       </para> 
      </listitem>
     </varlistentry>
     <varlistentry xml:id="pm.max-requests">
      <term>
       <parameter>pm.max_requests</parameter>
       <type>int</type>
      </term>
      <listitem>
       <para>
        各子プロセスが、再起動するまでに実行するリクエスト数。
        サードパーティのライブラリにおけるメモリリークの回避策として便利です。
        再起動せずにずっとリクエストを処理させる場合は '0' を指定します。
        <varname>PHP_FCGI_MAX_REQUESTS</varname> と同じです。デフォルト値: 0
       </para> 
      </listitem>
     </varlistentry>
     <varlistentry xml:id="pm.status-path">
      <term>
       <parameter>pm.status_path</parameter>
       <type>string</type>
      </term>
      <listitem>
       <para>
        FPM の情報ページを見るための URI。この値を省略した場合は、どの URI
        も情報ページとは見なされません。デフォルト値: なし
       </para> 
      </listitem>
     </varlistentry>
     <varlistentry xml:id="ping.path">
      <term>
       <parameter>ping.path</parameter>
       <type>string</type>
      </term>
      <listitem>
       <para>
        FPM のモニタリングページをコールするための ping URI。この値を省略した場合は、どの URI
        も ping ページとは見なされません。これを使うと、
        FPM が生きていて応答するかどうかを外部から確かめることができます。
        この値の最初はスラッシュ (/) で始めなければならないことに注意しましょう。
       </para> 
      </listitem>
     </varlistentry>
     <varlistentry xml:id="ping.response">
      <term>
       <parameter>ping.response</parameter>
       <type>string</type>
      </term>
      <listitem>
       <para>
        このディレクティブを使うと、ping リクエストに対するレスポンスをカスタマイズすることができます。
        このレスポンスは text/plain 形式となり、レスポンスコード 200 で返されます。
        デフォルト値: pong
       </para> 
      </listitem>
     </varlistentry>
     <varlistentry xml:id="request-terminate-timeout">
      <term>
       <parameter>request_terminate_timeout</parameter>
       <type>mixed</type>
      </term>
      <listitem>
       <para>
        単一のリクエストを処理する際のタイムアウト。この時間を過ぎるとワーカープロセスが kill されます。
        このオプションは、'max_execution_time' ini オプションが何らかの理由でスクリプトの実行を止められなかった場合に使われます。
        値 '0' は 'Off' を意味します。 
        使用可能な単位: s(秒)(デフォルト), m(分), h(時間) あるいは d(日)、
        デフォルト値: 0
       </para> 
      </listitem>
     </varlistentry>
     <varlistentry xml:id="request-slowlog-timeout">
      <term>
       <parameter>request_slowlog_timeout</parameter>
       <type>mixed</type>
      </term>
      <listitem>
       <para>
        単一のリクエストを処理する際のタイムアウト。この時間を過ぎると
        PHP のバックトレースが 'slowlog' ファイルに出力されます。 
        値 '0' は 'Off' を意味します。 
        使用可能な単位: s(秒)(デフォルト), m(分), h(時間) あるいは d(日)、
        デフォルト値: 0
       </para> 
      </listitem>
     </varlistentry>
     <varlistentry xml:id="slowlog">
      <term>
       <parameter>slowlog</parameter>
       <type>string</type>
      </term>
      <listitem>
       <para>
        遅いリクエストを記録するログファイル。デフォルト値:
        <literal>#INSTALL_PREFIX#/log/php-fpm.log.slow</literal>
       </para> 
      </listitem>
     </varlistentry>
     <varlistentry xml:id="rlimit-files">
      <term>
       <parameter>rlimit_files</parameter>
       <type>int</type>
      </term>
      <listitem>
       <para>
        オープン時のファイル記述子の rlimit。デフォルト値: システムで定義されている値
       </para> 
      </listitem>
     </varlistentry>
     <varlistentry xml:id="rlimit-core">
      <term>
       <parameter>rlimit_core</parameter>
       <type>int</type>
      </term>
      <listitem>
       <para>
        最大コアサイズの rlimit。
        使用可能な値: 'unlimited' あるいは 0 以上の整数値、
        デフォルト値: システムで定義されている値
       </para> 
      </listitem>
     </varlistentry>
     <varlistentry xml:id="chroot">
      <term>
       <parameter>chroot</parameter>
       <type>string</type>
      </term>
      <listitem>
       <para>
        このディレクトリに chroot して開始位置とします。この値は絶対パスで指定しなければなりません。
        この値を省略した場合は、chroot を使いません。
       </para> 
      </listitem>
     </varlistentry>
     <varlistentry xml:id="chdir">
      <term>
       <parameter>chdir</parameter>
       <type>string</type>
      </term>
      <listitem>
       <para>
        このディレクトリに chdir して開始位置とします。この値は絶対パスで指定しなければなりません。
        デフォルト値: カレントディレクトリ、あるいは chroot した場合は /
       </para> 
      </listitem>
     </varlistentry>
     <varlistentry xml:id="catch-workers-output">
      <term>
       <parameter>catch_workers_output</parameter>
       <type>boolean</type>
      </term>
      <listitem>
       <para>
        ワーカーの標準出力および標準エラー出力を本体のエラーログにリダイレクトします。
        省略した場合は、FastCGI の仕様にしたがって標準出力および標準エラー出力を
        /dev/null にリダイレクトします。
        デフォルト値: no
       </para> 
      </listitem>
     </varlistentry>
    </variablelist>
    <para>
     追加の環境変数を渡して、特定のプールだけで PHP の設定を更新することができます。
     そのためには、次のオプションを <filename>php-fpm.conf</filename> に追加しなければなりません。
     <example>
      <title>環境変数や PHP の設定をプールに渡す</title>
      <programlisting role="ini">
       <![CDATA[
       env[HOSTNAME] = $HOSTNAME
       env[PATH] = /usr/local/bin:/usr/bin:/bin
       env[TMP] = /tmp
       env[TMPDIR] = /tmp
       env[TEMP] = /tmp

       php_admin_value[sendmail_path] = /usr/sbin/sendmail -t -i -f www@my.domain.com
       php_flag[display_errors] = off
       php_admin_value[error_log] = /var/log/fpm-php.www.log
       php_admin_flag[log_errors] = on
       php_admin_value[memory_limit] = 32M
       ]]>
      </programlisting>
     </example>
     <literal>php_value</literal> や
     <literal>php_flag</literal> で渡した PHP の設定は、その前に設定されていた内容を上書きします。
     ただし
     <link linkend="ini.disable-functions">disable_functions</link> や
     <link linkend="ini.disable-classes">disable_classes</link> は別で、
     <filename>php.ini</filename> で定義された値を上書きするのではなく、
     新たに指定した値を追記することになります。
    </para>
    <para>
     <literal>php_admin_value</literal> や <literal>php_admin_flag</literal>
     で設定した値を <function>ini_set</function> で上書きすることはできません。
    </para>
   </sect2>
   
  </sect1>

<!-- Keep this comment at the end of the file
Local variables:
mode: sgml
sgml-omittag:t
sgml-shorttag:t
sgml-minimize-attributes:nil
sgml-always-quote-attributes:t
sgml-indent-step:1
sgml-indent-data:t
indent-tabs-mode:nil
sgml-parent-document:nil
sgml-default-dtd-file:"~/.phpdoc/manual.ced"
sgml-exposed-tags:nil
sgml-local-catalogs:nil
sgml-local-ecat-files:nil
End:
vim600: syn=xml fen fdm=syntax fdl=2 si
vim: et tw=78 syn=sgml
vi: ts=1 sw=1
-->
