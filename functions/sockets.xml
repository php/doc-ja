 <reference id="ref.sockets">
  <title>ソケット関数</title>
  <titleabbrev>ソケット</titleabbrev>
  <partintro>
   <simpara>
    ソケット拡張により、ソケット通信関数への低レベルなインターフェース
    が実装され、クライアントとしてだけでなく、ソケットサーバーとして動作する
    ことが可能となります。
   </simpara>
   <para>
    より一般的なクライアントサイドのソケットインターフェースについては、
    <function>fsockopen</function> および
    <function>pfsockopen</function>を参照下さい。
   </para>
   <para>
    ここで説明するソケット関数を使用する場合、多くの関数は、C言語に同
    じ名前の関数が存在しますが、定義が異なっていることに注意して下さい。
    混乱を避けるには、説明をよく読んで下さい。
   </para>
   <para>
    このようにソケットソケットプログラミングと異なっている点はあります
    が、それでも有用な多くのUNIX man ページを参照することができます。
    Web上にC言語のソケットプログラミングのチュートリアル情報が存在し、
    その多くは、若干の修正により、PHPにおけるソケットプログラミングに
    適当することが可能です。
   </para>
   <para>
    <example>
     <title>ソケットの例: 簡易TCP/IPサーバー</title>
     <para>
      この例は、簡単な応答サーバーです。変数<varname>address</varname>
      と<varname>port</varname>を設定と実行環境に合うように変更して下
      さい。このサーバーに次のようなコマンドで接続することが可能です。
      : <command>telnet 192.168.1.53 10000</command> (ただし、アドレス
      とポートは設定に合わせます)入力したものは、サーバー側の出力とな
      り、エコーバックされます。接続を閉じるには、'quit'を入力します。
     </para>
     <programlisting role="php">
&lt;?php
error_reporting(E_ALL);

/* 接続待ちの間、スクリプトを待機させるようにする。 */
set_time_limit(0);

$address = '192.168.1.53';
$port = 10000;

if (($sock = socket(AF_INET, SOCK_STREAM, 0)) &lt; 0) {
    echo "socket() failed: reason: " . strerror($sock) . "\n";
}

if (($ret = bind($sock, $address, $port)) &lt; 0) {
    echo "bind() failed: reason: " . strerror($ret) . "\n";
}

if (($ret = listen($sock, 5)) &lt; 0) {
    echo "listen() failed: reason: " . strerror($ret) . "\n";
}

do {
    if (($msgsock = accept_connect($sock)) &lt; 0) {
        echo "accept_connect() failed: reason: " . strerror($msgsock) . "\n";
        break;
    }
    do {
        $buf = '';
        $ret = read($msgsock, $buf, 2048);
        if ($ret &lt; 0) {
            echo "read() failed: reason: " . strerror($ret) . "\n";
            break 2;
        }
        if ($ret == 0) {
            break 2;
        }
        $buf = trim($buf);
        if ($buf == 'quit') {
            close($msgsock);
            break 2;
        }
        $talkback = "PHP: You said '$buf'.\n";
        write($msgsock, $talkback, strlen($talkback));
        echo "$buf\n";
    } while (true);
    close($msgsock);
} while (true);

close($sock);
?>
     </programlisting>
    </example>
   </para>
   <para>
    <example>
     <title>ソケットの例: 簡易 TCP/IP クライアント</title>
     <para>
      この例は、簡単な一回限りのHTTPクライアントです。ここでは、あるペー
      ジに接続し、HEADリクエストを送信し、応答を出力た後、終了します。
     </para>
     <programlisting role="php">
&lt;?php
error_reporting(E_ALL);

echo "&lt;h2>TCP/IP Connection&lt;/h2>\n";

/* WWWサービスのポートを得る。 */
$service_port = getservbyname('www', 'tcp');

/* ターゲットホストのIPアドレスを得る。 */
$address = gethostbyname('www.php.net');

/* TCP/IPソケットを作成する。 */
$socket = socket(AF_INET, SOCK_STREAM, 0);
if ($socket &lt; 0) {
    echo "socket() failed: reason: " . strerror($socket) . "\n";
} else {
    "socket() successful: " . strerror($socket) . "\n";
}

echo "Attempting to connect to '$address' on port '$service_port'...";
$result = connect($socket, $address, $service_port);
if ($result &lt; 0) {
    echo "connect() failed.\nReason: ($result) " . strerror($result) . "\n";
} else {
    echo "OK.\n";
}

$in = "HEAD / HTTP/1.0\r\n\r\n";
$out = '';

echo "Sending HTTP HEAD request...";
write($socket, $in, strlen($in));
echo "OK.\n";

echo "Reading response:\n\n";
while (read($socket, $out, 2048)) {
    echo $out;
}

echo "Closing socket...";
close($socket);
echo "OK.\n\n";
?>
     </programlisting>
    </example>
   </para>
  </partintro>

  <refentry id="function.accept-connect">
   <refnamediv>
    <refname>accept_connect</refname>
    <refpurpose>ソケットへの接続を許可する</refpurpose>
   </refnamediv>
   <refsect1>
    <title>説明</title>
    <funcsynopsis>
     <funcprototype>
      <funcdef>int <function>accept_connect</function></funcdef>
      <paramdef>int <parameter>socket</parameter></paramdef>
     </funcprototype>
    </funcsynopsis>
    <para>
     <function>socket</function>を使用してソケット
     <parameter>socket</parameter>を作成した後、
     <function>bind</function>で名前に関連付け、
     <function>listen</function>で接続をモニタします。この関数は、この
     ソケットへの接続を許可します。接続に成功すると、新規のソケット記
     述子が返されます。この記述子は、通信の際に使用可能です。ソケット
     上に複数の接続がキューで待っている場合、最初の接続が使用されます。
     接続待ちがない場合、<function>accept_connect</function>は接続が存
     在するまでブロックされます。<parameter>socket</parameter>が
     <function>socket_set_blocking</function>または
     <function>set_nonblock</function>により非ブロックモードで作成され
     た場合、エラーコードが返されます。
    </para>
    <para>
     <function>accept_connect</function>により返されたソケット記述子は、
     新規接続を許可するために使用することはできません。この場合でも元
     の接続待ちのソケット <parameter>socket</parameter>は、オープンさ
     れたままであり、再使用可能です。
    </para>
    <para>
     成功時に新規ソケット記述子を返し、失敗時に負のエラーコードを返し
     ます。このコードは、エラーの内容を文字列で取得するために
     <function>strerror</function>に渡すことが可能です。
    </para>
    <para>
     <function>accept_connect</function>の使用例については、
     <function>bind</function>のドキュメントを参照下さい。
    </para>
    <para>
     <function>bind</function>,
     <function>connect</function>,
     <function>listen</function>,
     <function>socket</function>,
     <function>strerror</function>も参照下さい。
    </para>
   </refsect1>
  </refentry>

  <refentry id="function.bind">
   <refnamediv>
    <refname>bind</refname>
    <refpurpose>ソケットに名前をバインドする</refpurpose>
   </refnamediv>
   <refsect1>
    <title>説明</title>
    <funcsynopsis>
     <funcprototype>
      <funcdef>int <function>bind</function></funcdef>
      <paramdef>int <parameter>socket</parameter></paramdef>
      <paramdef>string <parameter>address</parameter></paramdef>
      <paramdef>int 
       <parameter><optional>port</optional></parameter>
      </paramdef>
     </funcprototype>
    </funcsynopsis>
    <para>
     <function>bind</function>は、<parameter>address</parameter>で指定
     した名前を<parameter>socket</parameter>で指定したソケットにバイン
     ドします。このソケットは、<function>socket</function>で作成した有
     効なソケット記述子である必要があります。
    </para>
    <para>
     ソケットの種類が<constant>AF_INET</constant>の場合、パラメータ
     <parameter>address</parameter> は、4-ドット表記のIPアドレス(例:
     <literal>127.0.0.1</literal>)であり、<constant>AF_UNIX</constant>
     の場合はUNIXドメインソケットのパス名です。
    </para>
    <para>
     パラメータ<parameter>port</parameter>は、
     <constant>AF_INET</constant>ソケットに接続する場合にのみ使用され、
     接続するリモートホストのポートを指定します。
    </para>
    <para>
     成功時にゼロを返し、失敗時に負のエラーコードを返します。このコー
     ドは、エラーの内容を文字列で取得するために
     <function>strerror</function>に渡すことが可能です。
    </para>
    <para>
     <example>
      <title><function>bind</function>の例</title>
      <programlisting role="php">
&lt;?php
error_reporting(E_ALL);

/* スクリプトが接続を待ち続けることを許可する */
set_time_limit(0);

if (($sock = socket(AF_INET, SOCK_STREAM, 0)) &lt; 0) {
    echo "socket() failed: reason: " . strerror($sock) . "\n";
}

if (($ret = bind($sock, '192.168.1.53', 10001)) &lt; 0) {
    echo "bind() failed: reason: " . strerror($ret) . "\n";
}

if (($ret = listen($sock, 5)) &lt; 0) {
    echo "listen() failed: reason: " . strerror($ret) . "\n";
}

do {
    if (($msgsock = accept_connect($sock)) &lt; 0) {
        echo "accept_connect() failed: reason: " . strerror($msgsock) . "\n";
        break;
    }
    do {
        $buf = '';
        $ret = read($msgsock, $buf, 2048);
        if ($ret &lt; 0) {
            echo "read() failed: reason: " . strerror($ret) . "\n";
            break 2;
        }
        if ($ret == 0) {
            break 2;
        }
        $buf = trim($buf);
        if ($buf == 'quit') {
            close($msgsock);
            break 2;
        }
        $talkback = "PHP: You said '$buf'.\n";
        write($msgsock, $talkback, strlen($talkback));
        echo "$buf\n";
    } while (true);
    close($msgsock);
} while (true);

close($sock);
?>
      </programlisting>
     </example>
    </para>
    <para>
     <function>accept_connect</function>,
     <function>connect</function>,
     <function>listen</function>,
     <function>socket</function>,
     <function>strerror</function>も参照下さい。
    </para>
   </refsect1>
  </refentry>

  <refentry id="function.connect">
   <refnamediv>
    <refname>connect</refname>
    <refpurpose>ソケット上の接続を初期化する</refpurpose>
   </refnamediv>
   <refsect1>
    <title>説明</title>
    <funcsynopsis>
     <funcprototype>
      <funcdef>int <function>connect</function></funcdef>
      <paramdef>int <parameter>socket</parameter></paramdef>
      <paramdef>string <parameter>address</parameter></paramdef>
      <paramdef>int 
       <parameter><optional>protocol</optional></parameter>
      </paramdef>
     </funcprototype>
    </funcsynopsis>
    <para>
     ソケット記述子<parameter>socket</parameter>を用いて接続を初期化し
     ます。この記述子は、<function>socket</function>で作成した有効なソ
     ケット記述子である必要があります。
    </para>
    <para>
     ソケットの種類が<constant>AF_INET</constant>の場合、パラメータ
     <parameter>address</parameter> は、4-ドット表記のIPアドレス(例:
     <literal>127.0.0.1</literal>)であり、<constant>AF_UNIX</constant>
     の場合はUNIXドメインソケットのパス名です。
    </para>
    <para>
     パラメータ<parameter>port</parameter>は、
     <constant>AF_INET</constant>ソケットに接続する場合にのみ使用され、
     接続するリモートホストのポートを指定します。
    </para>
    <para>
     成功時にゼロを返し、失敗時に負のエラーコードを返します。このコー
     ドは、エラーの内容を文字列で取得するために
     <function>strerror</function>に渡すことが可能です。
    </para>
    <para>
     <example>
      <title><function>connect</function>の例</title>
      <programlisting role="php">
&lt;?php
error_reporting(E_ALL);

echo "&lt;h2>TCP/IP Connection&lt;/h2>\n";

/* WWW サービスのポートを取得 */
$service_port = getservbyname('www', 'tcp');

/* ターゲットホストのIPアドレスを取得 */
$address = gethostbyname('www.php.net');

/* TCP/IPソケットを作成 */
$socket = socket(AF_INET, SOCK_STREAM, 0);
if ($socket &lt; 0) {
    echo "socket() failed: reason: " . strerror($socket) . "\n";
} else {
    "socket() successful: " . strerror($socket) . "\n";
}

echo "Attempting to connect to '$address' on port '$service_port'...";
$result = connect($socket, $address, $service_port);
if ($result &lt; 0) {
    echo "connect() failed.\nReason: ($result) " . strerror($result) . "\n";
} else {
    echo "OK.\n";
}

$in = "HEAD / HTTP/1.0\r\n\r\n";
$out = '';

echo "Sending HTTP HEAD request...";
write($socket, $in, strlen($in));
echo "OK.\n";

echo "Reading response:\n\n";
while (read($socket, $out, 2048)) {
    echo $out;
}

echo "Closing socket...";
close($socket);
echo "OK.\n\n";
?>
      </programlisting>
     </example>
    </para>
    <para>
     <function>bind</function>,
     <function>listen</function>,
     <function>socket</function>, 
     <function>strerror</function>も参照下さい。
    </para>
   </refsect1>
  </refentry>

  <refentry id="function.listen">
   <refnamediv>
    <refname>listen</refname>
    <refpurpose>ソケット上で接続待ち(listen)する</refpurpose>
   </refnamediv>
   <refsect1>
    <title>Description</title>
    <funcsynopsis>
     <funcprototype>
      <funcdef>int <function>listen</function></funcdef>
      <paramdef>int <parameter>socket</parameter></paramdef>
      <paramdef>int <parameter>backlog</parameter></paramdef>
     </funcprototype>
    </funcsynopsis>
    <para>
     ソケット<parameter>socket</parameter>が
     <function>socket</function>を用いて作成され、
     <function>bind</function>で名前が付けられた後、
     <parameter>socket</parameter>上の接続要求を待つための通信ができる
     ようになります。最大<parameter>backlog</parameter>個の接続を処理
     用のキューで待ち受けることが可能です。
    </para>
    <para>
     <function>listen</function>はソケットが
     <literal>SOCK_STREAM</literal>型または
     <literal>SOCK_SEQPACKET</literal>型の場合のみ利用可能です。
    </para>
    <para>
     成功時にゼロ、失敗時に負のエラーコードを返します。このコードを
     <function>strerror</function>に指定することによりエラーの内容を文
     字列として取得可能です。
    </para>
    <para>
     <function>listen</function>の使用例については、
     <function>bind</function>の使用例の記述を参照下さい。
    </para>
    <para>
     <function>accept_connect</function>,
     <function>bind</function>,
     <function>connect</function>,
     <function>socket</function>,
     <function>strerror</function>も参照下さい。
    </para>
   </refsect1>
  </refentry>

  <refentry id="function.read">
   <refnamediv>
    <refname>read</refname>
    <refpurpose>ソケットから読みこむ</refpurpose>
   </refnamediv>
   <refsect1>
    <title>説明</title>
    <funcsynopsis>
     <funcprototype>
      <funcdef>int <function>read</function></funcdef>
      <paramdef>int <parameter>socket_des</parameter></paramdef>
      <paramdef>string <parameter>&amp;buffer</parameter></paramdef>
      <paramdef>int <parameter>length</parameter></paramdef>
     </funcprototype>
    </funcsynopsis>
    <para>
     関数 <function>read</function> は、関数
     <function>accept_connect</function> により作成されたソケット
     <parameter>socket_des</parameter> から
     <parameter>length</parameter> に設定されたバイト数分、
     <parameter>&amp;buffer</parameter> に読み込みます。これ以外に読
     み込みを終了するために \n、\t、\0 を使用することが可能です。読み
     込まれたバイト数が返されます。
    </para>
    <para>
     <function>accept_connect</function>,
     <function>bind</function>,
     <function>connect</function>,
     <function>listen</function>,
     <function>strerror</function>,
     <function>socket_get_status</function>,
     <function>write</function> も参照下さい。
    </para>
   </refsect1>
  </refentry>

  <refentry id="function.socket">
   <refnamediv>
    <refname>socket</refname>
    <refpurpose>ソケットを作成する(通信時の終端)</refpurpose>
   </refnamediv>
   <refsect1>
    <title>説明</title>
    <funcsynopsis>
     <funcprototype>
      <funcdef>int <function>socket</function></funcdef>
      <paramdef>int <parameter>domain</parameter></paramdef>
      <paramdef>int <parameter>type</parameter></paramdef>
      <paramdef>int <parameter>protocol</parameter></paramdef>
     </funcprototype>
    </funcsynopsis>
    <para>
     通信用の終端(ソケット)を作成し、そのソケットへの記述子を返します。
    </para>
    <para>
     パラメータ<parameter>domain</parameter>はドメインを設定します。現
     在、<constant>AF_INET</constant>および
     <constant>AF_UNIX</constant>が使用可轣Uれます。
    </para>
    <para>
     <parameter>type</parameter>パラメータはソケット型を選択します。
     これは、<constant>SOCK_STREAM</constant>,
     <constant>SOCK_DGRAM</constant>,
     <constant>SOCK_SEQPACKET</constant>,
     <constant>SOCK_RAW</constant>, <constant>SOCK_RDM</constant>, 
     <constant>SOCK_PACKET</constant>のどれかです。
    </para>
    <para>
     <parameter>protocol</parameter> はプロトコルを設定します。
    </para>
    <para>
     成功時に有効な記述子を返し、失敗時に負のエラーコードを返します。
     このコードを<function>strerror</function>に渡すことにより、エラー
     の内容を文字列で取得することが可能です。
    </para>
    <para>
     <function>socket</function>の使用法に関するより詳しい情報や種々の
     パラメータの意味については、UNIXマニュアルページ<filename>socket
     (2)</filename>を参照下さい。
    </para>
    <para>
     <function>accept_connect</function>,
     <function>bind</function>,
     <function>connect</function>,
     <function>listen</function>,
     <function>strerror</function>も参照下さい。
    </para>
   </refsect1>
  </refentry>

  <refentry id="function.strerror">
   <refnamediv>
    <refname>strerror</refname>
    <refpurpose>ソケットエラーの内容を文字列として返す</refpurpose>
   </refnamediv>
   <refsect1>
    <title>説明</title>
    <funcsynopsis>
     <funcprototype>
      <funcdef>string <function>strerror</function></funcdef>
      <paramdef>int <parameter>errno</parameter></paramdef>
     </funcprototype>
    </funcsynopsis>
    <para>
     <function>strerror</function> は、パラメータ
     <parameter>errno</parameter>にソケット関数の返り値の一つを引数と
     して指定し、対応する内容を文字列で返します。これは、動作しない原
     因を明らかにする際に便利です。例えば、システムのインクルードファ
     イルを探し'-111'が意味することを探す代わりに、これを
     <function>strerror</function>に渡すだけで、原因を知ることができま
     す。
    </para>
    <para>
     <example>
      <title><function>strerror</function>の例</title>
      <programlisting role="php">
&lt;?php
if (($socket = socket(AF_INET, SOCK_STREAM, 0)) &lt; 0) {
   echo "socket() failed: reason: " . strerror($socket) . "\n";
} 

if (($ret = bind($socket, '127.0.0.1', 80)) &lt; 0) {
   echo "bind() failed: reason: " . strerror($ret) . "\n";
}
?>
      </programlisting>
      <para>
       上記の例の出力はおそらく次のようになります。(このスクリプトがルー
       ト権限で実行されていないことを仮定します)
       <screen>
        bind() failed: reason: Permission denied
       </screen>
      </para>
     </example>
    </para>
    <para>
     <function>accept_connect</function>,
     <function>bind</function>,
     <function>connect</function>,
     <function>listen</function>, 
     <function>socket</function>も参照下さい。
    </para>
   </refsect1>
  </refentry>

  <refentry id="function.write">
   <refnamediv>
    <refname>write</refname>
    <refpurpose>ソケットに書き込む</refpurpose>
   </refnamediv>
   <refsect1>
    <title>説明</title>
    <funcsynopsis>
     <funcprototype>
      <funcdef>int <function>write</function></funcdef>
      <paramdef>int <parameter>socket_des</parameter></paramdef>
      <paramdef>string <parameter>&amp;buffer</parameter></paramdef>
      <paramdef>int <parameter>length</parameter></paramdef>
     </funcprototype>
    </funcsynopsis>
    <para>
     関数 <function>write</function> は、
     <parameter>length</parameter>で指定されたバイト数分、
     <parameter>&amp;buffer</parameter> の内容をソケット
     <parameter>socket_des</parameter> に書き込みます。
    </para>
    <para>
     <function>accept_connect</function>,
     <function>bind</function>,
     <function>connect</function>,
     <function>listen</function>,
     <function>read</function>,
     <function>strerror</function>,
     <function>socket_get_status</function> も参照下さい。
    </para>
   </refsect1>
  </refentry>

 </reference>

 <!-- Keep this comment at the end of the file
Local variables:
mode: sgml
sgml-omittag:t
sgml-shorttag:t
sgml-minimize-attributes:nil
sgml-always-quote-attributes:t
sgml-indent-step:1
sgml-indent-data:t
sgml-parent-document:nil
sgml-default-dtd-file:"../../manual.ced"
sgml-exposed-tags:nil
sgml-local-catalogs:nil
sgml-local-ecat-files:nil
End:
-->
 